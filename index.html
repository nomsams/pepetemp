<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PepeTalk OS | Magnum Opus Build</title>
    <meta name="theme-color" content="#0f0f12">
    
    <!-- External Kernels -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 
         * üç∑ VINTAGE STYLESHEET - 2024 RESERVE
         * "Structured, with notes of dark mode and smooth transitions."
         */

        :root {
            /* Palette: Midnight Strawberry */
            --bg-deep: #050505;
            --bg-surface: #0f0f12;
            --bg-panel: #16161a;
            --bg-elevated: #1e1e24;
            
            --primary: #ff2a2a;
            --primary-gradient: linear-gradient(135deg, #ff2a2a 0%, #c62828 100%);
            --primary-glow: rgba(255, 42, 42, 0.3);
            
            --accent: #00f0ff;
            --accent-glow: rgba(0, 240, 255, 0.2);
            
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --text-dim: #4a5568;
            
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --border-active: 1px solid rgba(255, 42, 42, 0.5);
            
            --glass: rgba(22, 22, 26, 0.7);
            --blur: blur(20px);
            
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Space Grotesk', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- BOOT SEQUENCE --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-deep); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'JetBrains Mono', monospace;
        }
        .boot-log { color: var(--primary); font-size: 0.8rem; margin-top: 20px; opacity: 0.7; }
        .loader-bar { width: 200px; height: 2px; background: #333; margin-top: 10px; position: relative; overflow: hidden; }
        .loader-bar::after {
            content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 0%;
            background: var(--primary); animation: load 2s ease-in-out forwards;
        }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }

        /* --- LAYOUT GRID --- */
        #os-root {
            display: grid;
            grid-template-columns: 80px 320px 1fr;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease;
        }
        #os-root.loaded { opacity: 1; }

        /* --- NAV RAIL --- */
        .nav-rail {
            background: var(--bg-surface);
            border-right: var(--border);
            display: flex; flex-direction: column; align-items: center;
            padding: 20px 0; gap: 20px;
            z-index: 100;
        }
        .nav-item {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s var(--ease-out);
            position: relative;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
        .nav-item .badge {
            position: absolute; top: -2px; right: -2px;
            width: 10px; height: 10px; background: var(--accent);
            border-radius: 50%; border: 2px solid var(--bg-surface);
            display: none;
        }

        /* --- SIDEBAR (CONTACTS/SETTINGS) --- */
        .sidebar {
            background: var(--bg-panel);
            border-right: var(--border);
            display: flex; flex-direction: column;
            position: relative;
        }
        .sidebar-header { padding: 25px; border-bottom: var(--border); }
        .app-title { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .app-title i { color: var(--primary); }
        
        .connection-status {
            margin: 20px; padding: 15px;
            background: var(--bg-elevated);
            border-radius: 12px; border: var(--border);
        }
        .status-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; margin-bottom: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
        .status-dot.online { background: #00e676; box-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }
        .status-dot.error { background: #ff1744; }
        
        .peer-id-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem; color: var(--text-muted);
            background: rgba(0,0,0,0.3); padding: 8px;
            border-radius: 6px; cursor: pointer;
            word-break: break-all; transition: 0.2s;
        }
        .peer-id-display:hover { color: var(--accent); background: rgba(0, 240, 255, 0.05); }

        /* --- MAIN STAGE --- */
        .stage {
            background: radial-gradient(circle at 90% 10%, rgba(255, 42, 42, 0.03), transparent 40%),
                        radial-gradient(circle at 10% 90%, rgba(0, 240, 255, 0.03), transparent 40%);
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Chat View */
        #chat-view { flex: 1; display: flex; flex-direction: column; height: 100%; }
        
        .chat-scroll-area {
            flex: 1; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }
        
        /* Message Bubbles */
        .msg-row { display: flex; gap: 15px; max-width: 70%; animation: slideUp 0.3s var(--ease-out); }
        .msg-row.local { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.remote { align-self: flex-start; }
        
        .avatar {
            width: 36px; height: 36px; border-radius: 10px;
            background: linear-gradient(45deg, #333, #444);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 0.8rem; color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .local .avatar { background: var(--primary-gradient); }
        
        .bubble {
            background: var(--bg-elevated);
            padding: 12px 18px; border-radius: 18px;
            font-size: 0.95rem; line-height: 1.6;
            border: var(--border);
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .local .bubble {
            background: var(--primary);
            color: white;
            border: none;
            border-bottom-right-radius: 4px;
        }
        .remote .bubble {
            border-bottom-left-radius: 4px;
        }

        /* Rich Media */
        .attachment-preview {
            margin-top: 8px; border-radius: 12px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 300px; position: relative;
        }
        .attachment-preview img { width: 100%; display: block; }
        
        .audio-player {
            display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;
            width: 250px;
        }
        .play-btn {
            width: 30px; height: 30px; border-radius: 50%;
            background: white; color: var(--primary);
            border: none; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .waveform-canvas { flex: 1; height: 30px; }

        /* Progress Bar for Chunks */
        .transfer-progress {
            width: 100%; height: 4px; background: rgba(0,0,0,0.3);
            border-radius: 2px; margin-top: 8px; overflow: hidden;
        }
        .transfer-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.2s; }

        /* Input Deck */
        .input-deck {
            padding: 20px 30px;
            background: var(--bg-surface);
            border-top: var(--border);
            display: flex; flex-direction: column; gap: 10px;
            position: relative; z-index: 50;
        }
        
        .deck-tools { display: flex; gap: 10px; }
        .tool-btn {
            background: transparent; border: 1px solid transparent;
            color: var(--text-muted); padding: 8px 12px; border-radius: 8px;
            cursor: pointer; transition: 0.2s; font-size: 1rem;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .tool-btn.active { color: var(--primary); background: rgba(255, 42, 42, 0.1); border-color: rgba(255, 42, 42, 0.2); }

        .input-wrapper {
            display: flex; gap: 15px; align-items: flex-end;
            background: var(--bg-deep);
            padding: 10px; border-radius: 16px;
            border: var(--border);
            transition: 0.3s;
        }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        
        textarea {
            flex: 1; background: transparent; border: none;
            color: white; font-family: inherit; font-size: 1rem;
            resize: none; max-height: 120px; padding: 8px;
            outline: none;
        }
        
        .send-fab {
            width: 42px; height: 42px; border-radius: 12px;
            background: var(--primary-gradient); color: white;
            border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s var(--ease-elastic);
        }
        .send-fab:hover { transform: scale(1.1); }
        .send-fab:active { transform: scale(0.95); }

        /* --- MODALS (Glassmorphism) --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s;
            justify-content: center; align-items: center;
        }
        .modal-backdrop.open { display: flex; opacity: 1; }
        
        .modal-window {
            background: var(--bg-panel);
            width: 90%; max-width: 600px;
            border-radius: 24px; border: var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95); transition: transform 0.3s var(--ease-out);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .modal-backdrop.open .modal-window { transform: scale(1); }
        
        .modal-header {
            padding: 20px 30px; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.02);
        }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        
        .modal-body { padding: 30px; overflow-y: auto; max-height: 70vh; }

        /* Canvas Modal Specifics */
        #canvas-modal .modal-window { max-width: 95vw; height: 90vh; }
        #canvas-modal .modal-body { padding: 0; display: flex; flex-direction: column; height: 100%; background: #1a1a1a; }
        #whiteboard-container { flex: 1; position: relative; overflow: hidden; cursor: crosshair; }
        #whiteboard { display: block; width: 100%; height: 100%; }
        
        .canvas-toolbar {
            padding: 15px; background: var(--bg-panel); border-top: var(--border);
            display: flex; justify-content: center; gap: 20px; align-items: center;
        }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-swatch.active { transform: scale(1.2); border-color: white; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #d32f2f; }
        .btn-ghost { background: transparent; border: var(--border); color: var(--text-main); }
        .btn-ghost:hover { border-color: var(--text-main); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #os-root { grid-template-columns: 1fr; }
            .nav-rail, .sidebar { display: none; position: absolute; height: 100%; z-index: 200; }
            .nav-rail.mobile-open, .sidebar.mobile-open { display: flex; }
            .msg-row { max-width: 85%; }
        }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 42, 42, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0); } }
    </style>
</head>
<body>

    <!-- Boot Screen -->
    <div id="boot-screen">
        <i class="fas fa-frog fa-3x" style="color: #ff2a2a; margin-bottom: 20px;"></i>
        <div style="font-weight: bold; font-size: 1.5rem;">PEPETALK OS</div>
        <div class="loader-bar"></div>
        <div class="boot-log" id="boot-log">Initializing Kernel...</div>
    </div>

    <div id="os-root">
        <!-- Navigation Rail -->
        <nav class="nav-rail">
            <div class="nav-item active" title="Chat"><i class="fas fa-comment-alt"></i></div>
            <div class="nav-item" onclick="OS.Apps.Whiteboard.open()" title="Whiteboard"><i class="fas fa-pen-nib"></i></div>
            <div class="nav-item" onclick="OS.Apps.Settings.open()" title="Settings"><i class="fas fa-cog"></i></div>
            <div style="flex:1"></div>
            <div class="nav-item" onclick="location.reload()" title="Reboot System"><i class="fas fa-power-off"></i></div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="app-title"><i class="fas fa-frog"></i> PepeTalk <span style="font-size:0.6em; opacity:0.5; margin-top:5px;">v3.0</span></div>
            </div>
            
            <div class="connection-status">
                <div class="status-row">
                    <span>STATUS</span>
                    <div id="status-dot" class="status-dot"></div>
                </div>
                <div class="status-row" style="color: var(--text-muted);">
                    <span id="status-text">Initializing...</span>
                </div>
                <div style="margin-top: 15px;">
                    <div style="font-size: 0.7rem; margin-bottom: 5px; color: #666;">YOUR SECURE ID</div>
                    <div id="my-peer-id" class="peer-id-display" onclick="OS.Network.copyId()">Generating...</div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px; font-size: 0.8rem;" onclick="OS.UI.openModal('invite-modal')">
                    <i class="fas fa-qrcode"></i> PAIR DEVICE
                </button>
            </div>

            <div style="padding: 20px; color: var(--text-dim); font-size: 0.75rem; text-align: center; margin-top: auto;">
                <i class="fas fa-shield-alt"></i> AES-256-GCM Encrypted<br>
                Chunked Data Transfer Protocol<br>
                Memory-Only Session
            </div>
        </aside>

        <!-- Main Stage -->
        <main class="stage">
            <div id="chat-view">
                <div class="chat-scroll-area" id="chat-feed">
                    <!-- System Welcome Message -->
                    <div style="text-align: center; margin: 40px 0; opacity: 0.6;">
                        <i class="fas fa-fingerprint" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <h3>Secure Channel Ready</h3>
                        <p>Messages are end-to-end encrypted. No server storage.<br>Large files are automatically chunked.</p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" style="padding: 0 30px; font-size: 0.8rem; color: var(--accent); opacity: 0; transition: 0.3s; height: 20px;">
                    <i class="fas fa-pen"></i> Peer is typing...
                </div>

                <div class="input-deck">
                    <!-- Audio Recorder Overlay -->
                    <div id="recorder-overlay" style="display: none; position: absolute; bottom: 100%; left: 0; width: 100%; background: var(--bg-elevated); padding: 20px; border-top: 1px solid var(--primary); z-index: 100;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="color: var(--primary); font-family: monospace; font-size: 1.2rem;" id="rec-timer">00:00</div>
                            <canvas id="rec-visualizer" style="flex: 1; height: 40px; background: #111; border-radius: 4px;"></canvas>
                            <button class="btn btn-ghost" onclick="OS.Media.Audio.cancel()"><i class="fas fa-times"></i></button>
                            <button class="btn btn-primary" onclick="OS.Media.Audio.stopAndSend()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>

                    <div class="deck-tools">
                        <button class="tool-btn" onclick="document.getElementById('file-input').click()" title="Attach File"><i class="fas fa-paperclip"></i></button>
                        <button class="tool-btn" id="btn-morse" onclick="OS.Apps.Chat.toggleMorse()" title="Morse Mode"><i class="fas fa-broadcast-tower"></i></button>
                        <button class="tool-btn" id="btn-mic" onclick="OS.Media.Audio.toggle()" title="Voice Note"><i class="fas fa-microphone"></i></button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea id="msg-input" placeholder="Type a secure message..." rows="1"></textarea>
                        <button class="send-fab" onclick="OS.Apps.Chat.send()"><i class="fas fa-arrow-up"></i></button>
                    </div>
                    <input type="file" id="file-input" hidden onchange="OS.Network.FileTransfer.handleSelect(this)">
                </div>
            </div>
        </main>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal-backdrop">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">Secure Pairing</span>
                <button class="btn btn-ghost" onclick="OS.UI.closeModal('invite-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="qrcode" style="display: inline-block; padding: 15px; background: white; border-radius: 12px; margin-bottom: 20px;"></div>
                <p style="color: var(--text-muted);">Scan to connect or share the secure link below.</p>
                
                <div style="background: #111; padding: 15px; border-radius: 8px; border: var(--border); margin: 15px 0; word-break: break-all; font-family: monospace; color: var(--accent);">
                    <span id="invite-link-text">Generating Link...</span>
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="OS.Network.copyLink()">Copy Link to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Whiteboard Modal -->
    <div id="canvas-modal" class="modal-backdrop">
        <div class="modal-window">
            <div class="modal-header">
                <span class="modal-title">Live Vector Canvas</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="OS.Apps.Whiteboard.save()">Send to Chat</button>
                    <button class="btn btn-ghost" onclick="OS.UI.closeModal('canvas-modal')"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="whiteboard-container">
                    <canvas id="whiteboard"></canvas>
                </div>
                <div class="canvas-toolbar">
                    <div class="color-swatch active" style="background: #ff2a2a;" onclick="OS.Apps.Whiteboard.setColor('#ff2a2a', this)"></div>
                    <div class="color-swatch" style="background: #00f0ff;" onclick="OS.Apps.Whiteboard.setColor('#00f0ff', this)"></div>
                    <div class="color-swatch" style="background: #00e676;" onclick="OS.Apps.Whiteboard.setColor('#00e676', this)"></div>
                    <div class="color-swatch" style="background: #ffffff;" onclick="OS.Apps.Whiteboard.setColor('#ffffff', this)"></div>
                    <div style="width: 1px; height: 30px; background: #444; margin: 0 10px;"></div>
                    <button class="tool-btn" onclick="OS.Apps.Whiteboard.undo()"><i class="fas fa-undo"></i></button>
                    <button class="tool-btn" onclick="OS.Apps.Whiteboard.clear()"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * üçì PEPETALK OS KERNEL v3.0
         * "A robust vintage."
         */

        const OS = {
            Config: {
                CHUNK_SIZE: 16384, // 16KB safe limit for WebRTC
                ICE_SERVERS: [{ urls: 'stun:stun.l.google.com:19302' }]
            },
            
            State: {
                isHost: true,
                peerId: null,
                conn: null,
                key: null,
                username: 'Me',
                morseMode: false
            },

            // --- BOOT SEQUENCE ---
            init: async () => {
                const log = (msg) => document.getElementById('boot-log').innerText = `> ${msg}`;
                
                try {
                    log("Loading Crypto Module...");
                    await OS.Security.init();
                    
                    log("Initializing Network Stack...");
                    // Check for invite hash
                    const hash = window.location.hash.substring(1);
                    if (hash) {
                        OS.State.isHost = false;
                        const [remoteId, keyStr] = hash.split('&k=');
                        if (remoteId && keyStr) {
                            await OS.Security.importKey(keyStr);
                            OS.Network.init(null, remoteId);
                        } else {
                            alert("Corrupted Invite Link");
                            OS.Network.init();
                        }
                    } else {
                        OS.Network.init();
                    }

                    log("Mounting UI...");
                    OS.UI.initListeners();
                    
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.display = 'none';
                        document.getElementById('os-root').classList.add('loaded');
                    }, 1500);

                } catch (e) {
                    log("CRITICAL ERROR: " + e.message);
                    console.error(e);
                }
            },

            // --- SECURITY LAYER (AES-GCM) ---
            Security: {
                key: null,
                
                init: async () => {
                    OS.Security.key = await window.crypto.subtle.generateKey(
                        { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
                    );
                },
                
                importKey: async (rawStr) => {
                    const binary = atob(rawStr.replace(/-/g, '+').replace(/_/g, '/'));
                    const bytes = new Uint8Array(binary.length);
                    for (let i=0; i<binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    OS.Security.key = await window.crypto.subtle.importKey(
                        "raw", bytes, "AES-GCM", true, ["encrypt", "decrypt"]
                    );
                },
                
                exportKey: async () => {
                    const exported = await window.crypto.subtle.exportKey("raw", OS.Security.key);
                    const buffer = new Uint8Array(exported);
                    return btoa(String.fromCharCode(...buffer)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                },
                
                encrypt: async (data) => {
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const encoded = new TextEncoder().encode(JSON.stringify(data));
                    const ciphertext = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv }, OS.Security.key, encoded
                    );
                    return { iv: Array.from(iv), data: Array.from(new Uint8Array(ciphertext)) };
                },
                
                decrypt: async (packed) => {
                    try {
                        const iv = new Uint8Array(packed.iv);
                        const data = new Uint8Array(packed.data);
                        const decrypted = await window.crypto.subtle.decrypt(
                            { name: "AES-GCM", iv: iv }, OS.Security.key, data
                        );
                        return JSON.parse(new TextDecoder().decode(decrypted));
                    } catch (e) {
                        console.error("Decryption Failed:", e);
                        return null;
                    }
                }
            },

            // --- NETWORK STACK ---
            Network: {
                peer: null,
                
                init: (id = null, connectTo = null) => {
                    OS.Network.peer = new Peer(id, { config: { iceServers: OS.Config.ICE_SERVERS }, debug: 1 });
                    
                    OS.Network.peer.on('open', async (myId) => {
                        OS.State.peerId = myId;
                        document.getElementById('my-peer-id').innerText = myId;
                        OS.UI.updateStatus('online', 'Ready to Pair');
                        
                        if (OS.State.isHost) {
                            const keyStr = await OS.Security.exportKey();
                            const link = `${window.location.origin}${window.location.pathname}#${myId}&k=${keyStr}`;
                            document.getElementById('invite-link-text').innerText = link;
                            new QRCode(document.getElementById("qrcode"), { text: link, width: 180, height: 180 });
                        }
                        
                        if (connectTo) OS.Network.connect(connectTo);
                    });

                    OS.Network.peer.on('connection', (conn) => OS.Network.bindConnection(conn));
                    OS.Network.peer.on('error', (err) => OS.UI.updateStatus('error', err.type));
                    OS.Network.peer.on('disconnected', () => OS.Network.peer.reconnect());
                },

                connect: (remoteId) => {
                    OS.UI.updateStatus('online', 'Connecting...');
                    const conn = OS.Network.peer.connect(remoteId);
                    OS.Network.bindConnection(conn);
                },

                bindConnection: (conn) => {
                    OS.State.conn = conn;
                    
                    conn.on('open', () => {
                        OS.UI.updateStatus('online', 'Secure Channel Active');
                        OS.UI.closeModal('invite-modal');
                        OS.Apps.Chat.addSystemMsg("End-to-End Encrypted Connection Established.");
                    });

                    conn.on('data', async (data) => {
                        if (data.iv) {
                            const decrypted = await OS.Security.decrypt(data);
                            if (decrypted) OS.Network.Router.route(decrypted);
                        }
                    });

                    conn.on('close', () => OS.UI.updateStatus('error', 'Peer Disconnected'));
                },

                send: async (type, payload) => {
                    if (OS.State.conn && OS.State.conn.open) {
                        const pkg = await OS.Security.encrypt({ type, payload, ts: Date.now() });
                        OS.State.conn.send(pkg);
                        return true;
                    }
                    return false;
                },

                copyId: () => {
                    navigator.clipboard.writeText(OS.State.peerId);
                    alert("ID Copied");
                },

                copyLink: () => {
                    const text = document.getElementById('invite-link-text').innerText;
                    navigator.clipboard.writeText(text);
                    alert("Link Copied");
                },

                // --- ROUTER ---
                Router: {
                    route: (msg) => {
                        switch(msg.type) {
                            case 'text': OS.Apps.Chat.render(msg.payload, 'remote'); break;
                            case 'morse': OS.Apps.Chat.renderMorse(msg.payload, 'remote'); break;
                            case 'typing': OS.Apps.Chat.showTyping(); break;
                            case 'chunk': OS.Network.FileTransfer.receiveChunk(msg.payload); break;
                            case 'draw': OS.Apps.Whiteboard.drawRemote(msg.payload); break;
                        }
                    }
                },

                // --- FILE TRANSFER (CHUNKED) ---
                FileTransfer: {
                    chunks: {}, // Map of fileId -> { data: [], received: 0, total: 0, meta: {} }
                    
                    handleSelect: (input) => {
                        const file = input.files[0];
                        if (!file) return;
                        OS.Network.FileTransfer.sendFile(file);
                    },

                    sendFile: async (file) => {
                        const fileId = Math.random().toString(36).substr(2, 9);
                        const totalChunks = Math.ceil(file.size / OS.Config.CHUNK_SIZE);
                        
                        // Render local placeholder
                        const uiId = OS.Apps.Chat.renderFilePlaceholder(file, 'local');
                        
                        const reader = new FileReader();
                        let offset = 0;
                        let chunkIndex = 0;

                        reader.onload = async (e) => {
                            const base64 = e.target.result; // This is the chunk
                            
                            await OS.Network.send('chunk', {
                                fileId: fileId,
                                index: chunkIndex,
                                total: totalChunks,
                                data: base64,
                                name: file.name,
                                type: file.type,
                                size: file.size
                            });

                            chunkIndex++;
                            offset += OS.Config.CHUNK_SIZE;
                            
                            // Update local UI
                            OS.Apps.Chat.updateProgress(uiId, chunkIndex / totalChunks);

                            if (offset < file.size) {
                                readNextChunk();
                            }
                        };

                        const readNextChunk = () => {
                            const slice = file.slice(offset, offset + OS.Config.CHUNK_SIZE);
                            reader.readAsDataURL(slice);
                        };

                        readNextChunk();
                    },

                    receiveChunk: (payload) => {
                        const { fileId, index, total, data, name, type, size } = payload;
                        
                        if (!OS.Network.FileTransfer.chunks[fileId]) {
                            OS.Network.FileTransfer.chunks[fileId] = {
                                chunks: [],
                                received: 0,
                                uiId: OS.Apps.Chat.renderFilePlaceholder({ name, size, type }, 'remote')
                            };
                        }
                        
                        const transfer = OS.Network.FileTransfer.chunks[fileId];
                        transfer.chunks[index] = data; // Store base64 chunk
                        transfer.received++;
                        
                        OS.Apps.Chat.updateProgress(transfer.uiId, transfer.received / total);

                        if (transfer.received === total) {
                            // Reassemble
                            // Note: dataURL chunks contain "data:image/png;base64," prefix. 
                            // For a robust implementation, we usually strip prefixes and merge blobs.
                            // For this single file demo, we will assume the browser can handle the concatenation of DataURLs 
                            // (Actually, we need to strip the header from chunks 1..n, or better, use ArrayBuffers. 
                            // To keep it simple in JS: we will just use the last chunk's data for small files or 
                            // trigger a download for large ones. 
                            // *Correction*: FileReader.readAsDataURL produces standalone valid strings. 
                            // We need to strip the scheme from all chunks and concat, then add scheme back.
                            
                            const fullBase64 = transfer.chunks.map((c, i) => {
                                return i === 0 ? c : c.split(',')[1];
                            }).join('');
                            
                            OS.Apps.Chat.finalizeFile(transfer.uiId, fullBase64, type);
                            delete OS.Network.FileTransfer.chunks[fileId];
                        }
                    }
                }
            },

            // --- APPS ---
            Apps: {
                Chat: {
                    typingTimeout: null,
                    
                    send: () => {
                        const input = document.getElementById('msg-input');
                        const text = input.value.trim();
                        if (!text) return;

                        if (OS.State.morseMode) {
                            const code = OS.Apps.Chat.toMorse(text);
                            OS.Network.send('morse', { text, code });
                            OS.Apps.Chat.renderMorse({ text, code }, 'local');
                        } else {
                            OS.Network.send('text', text);
                            OS.Apps.Chat.render(text, 'local');
                        }
                        input.value = '';
                        input.style.height = 'auto';
                    },

                    render: (content, source) => {
                        const feed = document.getElementById('chat-feed');
                        const div = document.createElement('div');
                        div.className = `msg-row ${source}`;
                        div.innerHTML = `
                            <div class="avatar">${source === 'local' ? 'ME' : 'P'}</div>
                            <div class="bubble">${DOMPurify.sanitize(content).replace(/\n/g, '<br>')}</div>
                        `;
                        feed.appendChild(div);
                        feed.scrollTop = feed.scrollHeight;
                    },

                    renderMorse: (payload, source) => {
                        if (source === 'remote') OS.Media.Audio.playMorse(payload.code);
                        OS.Apps.Chat.render(`
                            <div style="font-family:monospace; color:var(--accent); letter-spacing:2px;">${payload.code}</div>
                            <div style="font-size:0.8em; opacity:0.7; margin-top:5px;">${payload.text}</div>
                        `, source);
                    },

                    renderFilePlaceholder: (file, source) => {
                        const id = 'file-' + Math.random().toString(36).substr(2, 9);
                        const feed = document.getElementById('chat-feed');
                        const div = document.createElement('div');
                        div.className = `msg-row ${source}`;
                        div.innerHTML = `
                            <div class="avatar">${source === 'local' ? 'ME' : 'P'}</div>
                            <div class="bubble" id="${id}">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <i class="fas fa-file"></i>
                                    <div>
                                        <div style="font-weight:bold;">${file.name}</div>
                                        <div style="font-size:0.7em;">${(file.size/1024).toFixed(1)} KB</div>
                                    </div>
                                </div>
                                <div class="transfer-progress"><div class="transfer-bar"></div></div>
                            </div>
                        `;
                        feed.appendChild(div);
                        feed.scrollTop = feed.scrollHeight;
                        return id;
                    },

                    updateProgress: (id, pct) => {
                        const el = document.getElementById(id);
                        if (el) el.querySelector('.transfer-bar').style.width = (pct * 100) + '%';
                    },

                    finalizeFile: (id, base64, type) => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        
                        let content = '';
                        if (type.startsWith('image/')) {
                            content = `<div class="attachment-preview"><img src="${base64}"></div>`;
                        } else if (type.startsWith('audio/')) {
                            content = `<audio controls src="${base64}" style="margin-top:10px; width:200px;"></audio>`;
                        } else {
                            content = `<a href="${base64}" download="file" class="btn btn-primary" style="display:inline-block; margin-top:10px; font-size:0.8rem;">Download</a>`;
                        }
                        
                        el.querySelector('.transfer-progress').remove();
                        el.insertAdjacentHTML('beforeend', content);
                    },

                    addSystemMsg: (text) => {
                        const feed = document.getElementById('chat-feed');
                        const div = document.createElement('div');
                        div.style = "text-align:center; font-size:0.75rem; color:var(--text-muted); margin:10px 0;";
                        div.innerText = text;
                        feed.appendChild(div);
                    },

                    toggleMorse: () => {
                        OS.State.morseMode = !OS.State.morseMode;
                        document.getElementById('btn-morse').classList.toggle('active');
                        document.getElementById('msg-input').placeholder = OS.State.morseMode ? "TYPE FOR MORSE..." : "Type a secure message...";
                    },

                    toMorse: (text) => {
                        const dict = { 'A':'.-', 'B':'-...', 'C':'-.-.', 'D':'-..', 'E':'.', 'F':'..-.', 'G':'--.', 'H':'....', 'I':'..', 'J':'.---', 'K':'-.-', 'L':'.-..', 'M':'--', 'N':'-.', 'O':'---', 'P':'.--.', 'Q':'--.-', 'R':'.-.', 'S':'...', 'T':'-', 'U':'..-', 'V':'...-', 'W':'.--', 'X':'-..-', 'Y':'-.--', 'Z':'--..', '1':'.----', '2':'..---', '3':'...--', '4':'....-', '5':'.....', '6':'-....', '7':'--...', '8':'---..', '9':'----.', '0':'-----', ' ': '/' };
                        return text.toUpperCase().split('').map(c => dict[c] || c).join(' ');
                    },

                    showTyping: () => {
                        const el = document.getElementById('typing-indicator');
                        el.style.opacity = 1;
                        clearTimeout(OS.Apps.Chat.typingTimeout);
                        OS.Apps.Chat.typingTimeout = setTimeout(() => el.style.opacity = 0, 2000);
                    }
                },

                Whiteboard: {
                    canvas: null,
                    ctx: null,
                    isDrawing: false,
                    color: '#ff2a2a',
                    history: [],
                    
                    open: () => {
                        OS.UI.openModal('canvas-modal');
                        setTimeout(OS.Apps.Whiteboard.init, 100);
                    },

                    init: () => {
                        const c = document.getElementById('whiteboard');
                        const container = document.getElementById('whiteboard-container');
                        c.width = container.clientWidth;
                        c.height = container.clientHeight;
                        OS.Apps.Whiteboard.canvas = c;
                        OS.Apps.Whiteboard.ctx = c.getContext('2d');
                        
                        // Events
                        const start = (e) => {
                            OS.Apps.Whiteboard.isDrawing = true;
                            const {x, y} = OS.Apps.Whiteboard.getPos(e);
                            OS.Apps.Whiteboard.lastX = x;
                            OS.Apps.Whiteboard.lastY = y;
                            OS.Apps.Whiteboard.saveState();
                        };
                        const move = (e) => {
                            if (!OS.Apps.Whiteboard.isDrawing) return;
                            e.preventDefault();
                            const {x, y} = OS.Apps.Whiteboard.getPos(e);
                            OS.Apps.Whiteboard.draw(OS.Apps.Whiteboard.lastX, OS.Apps.Whiteboard.lastY, x, y, OS.Apps.Whiteboard.color);
                            
                            // Broadcast normalized
                            OS.Network.send('draw', {
                                x1: OS.Apps.Whiteboard.lastX / c.width,
                                y1: OS.Apps.Whiteboard.lastY / c.height,
                                x2: x / c.width,
                                y2: y / c.height,
                                color: OS.Apps.Whiteboard.color
                            });
                            
                            [OS.Apps.Whiteboard.lastX, OS.Apps.Whiteboard.lastY] = [x, y];
                        };
                        const end = () => OS.Apps.Whiteboard.isDrawing = false;

                        c.addEventListener('mousedown', start);
                        c.addEventListener('mousemove', move);
                        c.addEventListener('mouseup', end);
                        c.addEventListener('touchstart', start);
                        c.addEventListener('touchmove', move);
                        c.addEventListener('touchend', end);
                    },

                    getPos: (e) => {
                        const rect = OS.Apps.Whiteboard.canvas.getBoundingClientRect();
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        return { x: clientX - rect.left, y: clientY - rect.top };
                    },

                    draw: (x1, y1, x2, y2, color) => {
                        const ctx = OS.Apps.Whiteboard.ctx;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.stroke();
                    },

                    drawRemote: (data) => {
                        if (!OS.Apps.Whiteboard.canvas) return;
                        const w = OS.Apps.Whiteboard.canvas.width;
                        const h = OS.Apps.Whiteboard.canvas.height;
                        OS.Apps.Whiteboard.draw(data.x1 * w, data.y1 * h, data.x2 * w, data.y2 * h, data.color);
                    },

                    setColor: (c, el) => {
                        OS.Apps.Whiteboard.color = c;
                        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                        el.classList.add('active');
                    },

                    saveState: () => {
                        OS.Apps.Whiteboard.history.push(OS.Apps.Whiteboard.canvas.toDataURL());
                    },

                    undo: () => {
                        if (OS.Apps.Whiteboard.history.length > 0) {
                            const img = new Image();
                            img.src = OS.Apps.Whiteboard.history.pop();
                            img.onload = () => {
                                OS.Apps.Whiteboard.ctx.clearRect(0,0,OS.Apps.Whiteboard.canvas.width, OS.Apps.Whiteboard.canvas.height);
                                OS.Apps.Whiteboard.ctx.drawImage(img, 0, 0);
                            }
                        }
                    },

                    clear: () => {
                        OS.Apps.Whiteboard.ctx.clearRect(0,0,OS.Apps.Whiteboard.canvas.width, OS.Apps.Whiteboard.canvas.height);
                    },

                    save: () => {
                        const data = OS.Apps.Whiteboard.canvas.toDataURL('image/png');
                        OS.Network.send('chunk', {
                            fileId: 'draw-' + Date.now(),
                            index: 0, total: 1, data: data,
                            name: 'whiteboard.png', type: 'image/png', size: 0
                        });
                        OS.Apps.Chat.render(`<img src="${data}" class="attachment-preview">`, 'local');
                        OS.UI.closeModal('canvas-modal');
                    }
                },

                Settings: {
                    open: () => alert("Settings Module: User preferences are stored in memory for this session.")
                }
            },

            // --- MEDIA ENGINE ---
            Media: {
                Audio: {
                    ctx: null,
                    recorder: null,
                    chunks: [],
                    timerInt: null,
                    
                    toggle: async () => {
                        const overlay = document.getElementById('recorder-overlay');
                        if (overlay.style.display === 'block') return;
                        
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            OS.Media.Audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
                            OS.Media.Audio.recorder = new MediaRecorder(stream);
                            OS.Media.Audio.chunks = [];
                            
                            OS.Media.Audio.recorder.ondataavailable = e => OS.Media.Audio.chunks.push(e.data);
                            OS.Media.Audio.recorder.start();
                            
                            overlay.style.display = 'block';
                            OS.Media.Audio.startVisualizer(stream);
                            OS.Media.Audio.startTimer();
                            
                        } catch (e) {
                            alert("Microphone Access Denied");
                        }
                    },

                    stopAndSend: () => {
                        OS.Media.Audio.recorder.onstop = () => {
                            const blob = new Blob(OS.Media.Audio.chunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => {
                                // Send as chunked file
                                OS.Network.FileTransfer.sendFile(new File([blob], "voice-note.webm", { type: 'audio/webm' }));
                                OS.Media.Audio.cleanup();
                            };
                        };
                        OS.Media.Audio.recorder.stop();
                    },

                    cancel: () => {
                        if (OS.Media.Audio.recorder) OS.Media.Audio.recorder.stop();
                        OS.Media.Audio.cleanup();
                    },

                    cleanup: () => {
                        document.getElementById('recorder-overlay').style.display = 'none';
                        clearInterval(OS.Media.Audio.timerInt);
                        document.getElementById('rec-timer').innerText = "00:00";
                        if (OS.Media.Audio.recorder) OS.Media.Audio.recorder.stream.getTracks().forEach(t => t.stop());
                    },

                    startTimer: () => {
                        const start = Date.now();
                        OS.Media.Audio.timerInt = setInterval(() => {
                            const s = Math.floor((Date.now() - start)/1000);
                            document.getElementById('rec-timer').innerText = `00:${s.toString().padStart(2,'0')}`;
                        }, 1000);
                    },

                    startVisualizer: (stream) => {
                        const canvas = document.getElementById('rec-visualizer');
                        const ctx = canvas.getContext('2d');
                        const source = OS.Media.Audio.ctx.createMediaStreamSource(stream);
                        const analyser = OS.Media.Audio.ctx.createAnalyser();
                        source.connect(analyser);
                        const data = new Uint8Array(analyser.frequencyBinCount);
                        
                        const draw = () => {
                            if (document.getElementById('recorder-overlay').style.display === 'none') return;
                            requestAnimationFrame(draw);
                            analyser.getByteFrequencyData(data);
                            ctx.fillStyle = '#1e1e24';
                            ctx.fillRect(0,0,canvas.width, canvas.height);
                            const barW = canvas.width / 50;
                            for(let i=0; i<50; i++) {
                                const h = (data[i] / 255) * canvas.height;
                                ctx.fillStyle = '#ff2a2a';
                                ctx.fillRect(i*barW, canvas.height - h, barW-1, h);
                            }
                        };
                        draw();
                    },

                    playMorse: (code) => {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const dot = 0.08;
                        let t = ctx.currentTime;
                        
                        code.split('').forEach(c => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.frequency.value = 600;
                            
                            if (c === '.') {
                                osc.start(t);
                                osc.stop(t + dot);
                                t += dot * 2;
                            } else if (c === '-') {
                                osc.start(t);
                                osc.stop(t + dot * 3);
                                t += dot * 4;
                            } else {
                                t += dot * 2;
                            }
                        });
                    }
                }
            },

            // --- UI MANAGER ---
            UI: {
                initListeners: () => {
                    document.getElementById('msg-input').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            OS.Apps.Chat.send();
                        }
                        OS.Network.send('typing', {});
                    });
                    
                    // Auto resize textarea
                    const tx = document.getElementById('msg-input');
                    tx.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = (this.scrollHeight) + 'px';
                    });
                },

                updateStatus: (state, text) => {
                    const dot = document.getElementById('status-dot');
                    const txt = document.getElementById('status-text');
                    dot.className = `status-dot ${state}`;
                    txt.innerText = text;
                },

                openModal: (id) => document.getElementById(id).classList.add('open'),
                closeModal: (id) => document.getElementById(id).classList.remove('open')
            }
        };

        // Boot
        window.onload = OS.init;

    </script>
</body>
</html>
